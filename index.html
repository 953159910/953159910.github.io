
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>JS-Craft Ultimate Fix</title>
    <style>
        /* CSSï¼šç¡®ä¿æ‰€æœ‰ UI å±‚çº§æ­£ç¡® */
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: #000; font-family: 'Segoe UI', sans-serif; }
        canvas { position: fixed; inset: 0; z-index: 1; display: block; }

        /* ç»Ÿä¸€é®ç½©å±‚ */
        .layer { position: fixed; inset: 0; z-index: 100; display: none; flex-direction: column; align-items: center; justify-content: center; background: rgba(0,0,0,0.8); color: white; }
        .active { display: flex !important; }

        /* æŒ‰é’®ä¸èœå• */
        .btn { width: 220px; padding: 12px; margin: 8px; background: #555; border: 3px solid #000; color: #fff; text-align: center; cursor: pointer; font-weight: bold; }
        .btn:active { background: #333; transform: scale(0.98); }
        .row { display: flex; gap: 10px; margin: 10px; }
        .selected { background: #5da048 !important; border-color: #fff; }

        /* èƒŒåŒ…ç•Œé¢ */
        .inv-box { background: #c6c6c6; padding: 20px; border: 4px solid #333; color: #000; width: 90%; max-width: 450px; }
        .inv-grid { display: grid; grid-template-columns: repeat(9, 1fr); gap: 4px; margin-top: 10px; }
        .slot { aspect-ratio: 1; background: #8b8b8b; border: 2px solid #373737; }
        .char-area { width: 80px; height: 120px; background: #000; border: 2px solid #333; margin-bottom: 10px; }

        /* æ¸¸æˆæ§åˆ¶ (æœ€é«˜å±‚çº§) */
        #game-ui { position: fixed; inset: 0; z-index: 50; display: none; pointer-events: none; }
        #joystick-zone { position: absolute; bottom: 40px; left: 40px; width: 120px; height: 120px; background: rgba(255,255,255,0.1); border-radius: 50%; pointer-events: all; }
        #stick { position: absolute; inset: 35px; background: #fff; border-radius: 50%; opacity: 0.5; }
        
        .action-group { position: absolute; bottom: 30px; right: 20px; display: grid; grid-template-columns: 1fr 1fr; gap: 15px; pointer-events: all; }
        .circ-btn { width: 65px; height: 65px; background: rgba(0,0,0,0.5); border: 2px solid #fff; border-radius: 50%; color: white; display: flex; align-items: center; justify-content: center; font-size: 13px; }

        #hud { position: fixed; top: 10px; left: 10px; z-index: 60; color: white; text-shadow: 2px 2px #000; pointer-events: none; }
    </style>
</head>
<body>

    <canvas id="game-canvas"></canvas>

    <div id="ui-main" class="layer active">
        <h1 style="color: #7fef34; font-size: 48px; text-shadow: 3px 3px #000;">JS-CRAFT</h1>
        <div class="btn" onclick="UI.show('ui-saves')">å¼€å§‹æ¸¸æˆ</div>
        <div class="btn" onclick="UI.show('ui-settings')">æ¸¸æˆè®¾ç½®</div>
    </div>

    <div id="ui-saves" class="layer">
        <h2>åˆ›å»ºæ–°ä¸–ç•Œ</h2>
        <div class="row">
            <div id="mode-surv" class="btn selected" style="width:100px" onclick="Game.setMode('survival')">ç”Ÿå­˜</div>
            <div id="mode-crea" class="btn" style="width:100px" onclick="Game.setMode('creative')">åˆ›é€ </div>
        </div>
        <div class="btn" style="background: #4a7a3a" onclick="Game.start()">è¿›å…¥ä¸–ç•Œ</div>
        <div class="btn" onclick="UI.show('ui-main')">è¿”å›</div>
    </div>

    <div id="ui-settings" class="layer">
        <h2>è®¾ç½®</h2>
        <div style="margin: 20px;">
            è§†é‡ (FOV): <input type="range" min="50" max="110" value="75" oninput="Game.updateFOV(this.value)">
        </div>
        <div class="btn" onclick="UI.show('ui-main')">å®Œæˆ</div>
    </div>

    <div id="ui-inv" class="layer">
        <div class="inv-box">
            <div style="display:flex; gap:20px">
                <div class="char-area"></div>
                <div>
                    <p>è£…å¤‡æ§½</p>
                    <div style="display:flex; gap:5px"><div class="slot" style="width:30px"></div><div class="slot" style="width:30px"></div></div>
                </div>
            </div>
            <div class="inv-grid" id="inv-grid-container"></div>
            <div class="btn" style="width:100%; margin-top:15px" onclick="UI.hideAll()">å…³é—­</div>
        </div>
    </div>

    <div id="hud" style="display:none">â¤ï¸ HP: <span id="hp">20</span> | ğŸ– <span id="hg">20</span></div>
    
    <div id="game-ui">
        <div id="joystick-zone"><div id="stick"></div></div>
        <div class="action-group">
            <div class="circ-btn" onclick="UI.show('ui-inv')">èƒŒåŒ…</div>
            <div class="circ-btn" id="btn-jump">è·³è·ƒ</div>
            <div class="circ-btn" onclick="Game.action('dig')">ç ´å</div>
            <div class="circ-btn" onclick="Game.action('place')">æ”¾ç½®</div>
            <div class="circ-btn" id="btn-crouch">ä¸‹è¹²</div>
            <div class="circ-btn" onclick="UI.show('ui-main')">èœå•</div>
        </div>
    </div>

<script type="importmap">
    { "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js" } }
</script>

<script type="module">
    import * as THREE from 'three';

    const UI = {
        show: (id) => {
            document.querySelectorAll('.layer').forEach(l => l.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            Game.isPlaying = false;
        },
        hideAll: () => {
            document.querySelectorAll('.layer').forEach(l => l.classList.remove('active'));
            Game.isPlaying = true;
        }
    };

    const Game = {
        scene: null, camera: null, renderer: null,
        isPlaying: false,
        mode: 'survival',
        player: { vel: new THREE.Vector3(), onGround: false },
        moveDir: { f: 0, r: 0 },
        chunks: new Map(),

        init() {
            // ç«‹å³åˆå§‹åŒ–æ¸²æŸ“å™¨ï¼Œé˜²æ­¢é»‘å±
            this.scene = new THREE.Scene();
            this.scene.background = new THREE.Color(0x87ceeb);
            this.camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
            
            this.renderer = new THREE.WebGLRenderer({ 
                canvas: document.getElementById('game-canvas'),
                antialias: false 
            });
            this.renderer.setSize(window.innerWidth, window.innerHeight);
            this.renderer.setPixelRatio(window.devicePixelRatio);

            const light = new THREE.HemisphereLight(0xffffff, 0x444444, 1.2);
            this.scene.add(light);

            this.setupControls();
            this.initInv();
            this.animate();
        },

        setMode(m) {
            this.mode = m;
            document.getElementById('mode-surv').classList.toggle('selected', m==='survival');
            document.getElementById('mode-crea').classList.toggle('selected', m==='creative');
        },

        updateFOV(v) {
            this.camera.fov = v;
            this.camera.updateProjectionMatrix();
        },

        start() {
            UI.hideAll();
            document.getElementById('game-ui').style.display = 'block';
            document.getElementById('hud').style.display = 'block';
            this.camera.position.set(0, 20, 0);
            this.isPlaying = true;
        },

        initInv() {
            const container = document.getElementById('inv-grid-container');
            for(let i=0; i<27; i++) {
                const s = document.createElement('div');
                s.className = 'slot';
                container.appendChild(s);
            }
        },

        setupControls() {
            const stick = document.getElementById('stick');
            document.getElementById('joystick-zone').addEventListener('touchmove', (e) => {
                const t = e.touches[0];
                const r = e.currentTarget.getBoundingClientRect();
                const dx = t.clientX - (r.left + 60), dy = t.clientY - (r.top + 60);
                const d = Math.min(Math.sqrt(dx*dx+dy*dy), 45);
                const a = Math.atan2(dy, dx);
                stick.style.transform = `translate(${Math.cos(a)*d}px, ${Math.sin(a)*d}px)`;
                this.moveDir.f = -Math.sin(a) * (d/45);
                this.moveDir.r = Math.cos(a) * (d/45);
            });
            document.getElementById('joystick-zone').addEventListener('touchend', () => {
                stick.style.transform = 'translate(0,0)';
                this.moveDir = { f:0, r:0 };
            });

            document.getElementById('btn-jump').addEventListener('touchstart', () => {
                if(this.player.onGround || this.mode === 'creative') this.player.vel.y = 0.15;
            });
            
            document.getElementById('btn-crouch').addEventListener('touchstart', () => { this.camera.position.y -= 0.5; });
            document.getElementById('btn-crouch').addEventListener('touchend', () => { this.camera.position.y += 0.5; });
        },

        action(type) {
            console.log("æ‰§è¡ŒåŠ¨ä½œ: " + type);
            // è¿™é‡Œä»¥åå¯ä»¥åŠ  Raycaster æŒ–æ˜é€»è¾‘
        },

        generateChunk(cx, cz) {
            const size = 10;
            const group = new THREE.Group();
            const geo = new THREE.BoxGeometry(1, 1, 1);
            const mat = new THREE.MeshLambertMaterial({ color: 0x5da048 });

            for(let x=0; x<size; x++) {
                for(let z=0; z<size; z++) {
                    const wx = cx * size + x;
                    const wz = cz * size + z;
                    const h = Math.floor(Math.sin(wx*0.2) * 2 + 5);
                    const mesh = new THREE.Mesh(geo, mat);
                    mesh.position.set(wx, h, wz);
                    group.add(mesh);
                }
            }
            this.scene.add(group);
            this.chunks.set(`${cx},${cz}`, group);
        },

        animate() {
            requestAnimationFrame(() => this.animate());
            
            if(this.isPlaying) {
                // ç‰©ç†
                if(this.mode === 'survival') this.player.vel.y -= 0.008;
                else this.player.vel.y *= 0.8; // åˆ›é€ æ¨¡å¼ç¼“æ…¢å‡é€Ÿ

                this.camera.position.y += this.player.vel.y;

                // åœ°é¢æ£€æµ‹
                if(this.camera.position.y < 10) {
                    this.camera.position.y = 10;
                    this.player.vel.y = 0;
                    this.player.onGround = true;
                } else {
                    this.player.onGround = false;
                }

                // ç§»åŠ¨
                this.camera.translateZ(-this.moveDir.f * 0.15);
                this.camera.translateX(this.moveDir.r * 0.15);

                // æ— é™åœ°å½¢åŠ è½½
                const cx = Math.floor(this.camera.position.x / 10);
                const cz = Math.floor(this.camera.position.z / 10);
                for(let x=cx-1; x<=cx+1; x++) {
                    for(let z=cz-1; z<=cz+1; z++) {
                        if(!this.chunks.has(`${x},${z}`)) this.generateChunk(x, z);
                    }
                }
            }
            
            this.renderer.render(this.scene, this.camera);
        }
    };

    window.UI = UI;
    window.Game = Game;
    Game.init();

</script>
</body>
</html>
